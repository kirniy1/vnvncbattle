<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VNVNC Coin Battle</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Roboto', Arial, sans-serif;
            text-align: center;
            margin: 0;
            padding: 0;
            background-color: black;
            color: red;
            display: flex;
            flex-direction: column;
            height: 100vh;
            box-sizing: border-box;
            overflow: hidden;
        }
        #gameContainer {
            display: flex;
            flex-direction: column;
            height: calc(100% - 50px);
            justify-content: space-between;
            padding: 10px;
        }
        #header {
            margin-bottom: 10px;
        }
        .framed {
            border: 2px solid red;
            border-radius: 10px;
            padding: 5px;
            margin-bottom: 5px;
        }
        h1 {
            font-size: 24px;
            margin: 0;
            font-weight: 700;
            text-shadow: 2px 2px 4px rgba(255,0,0,0.5);
        }
        #instructions {
            font-size: 14px;
            margin-top: 5px;
            background-color: rgba(255, 0, 0, 0.1);
            padding: 5px;
            border-radius: 5px;
        }
        #stars {
            font-size: 32px;
            font-weight: bold;
            margin: 0;
        }
        #coin {
            width: 200px;
            height: 200px;
            background: radial-gradient(circle at 30% 30%, #ffd700, #ffb700);
            border-radius: 50%;
            margin: 10px auto;
            cursor: pointer;
            user-select: none;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            color: #2b2640;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
            box-shadow: 
                0 10px 20px rgba(255,0,0,0.4), 
                0 5px 10px rgba(255,0,0,0.3),
                inset 0 -10px 10px -5px rgba(0,0,0,0.5),
                inset 0 10px 10px -5px rgba(255,255,255,0.5);
            position: relative;
            overflow: hidden;
            transition: transform 0.1s;
        }
        #coin::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(
                45deg,
                rgba(255,255,255,0) 0%,
                rgba(255,255,255,0.1) 50%,
                rgba(255,255,255,0) 100%
            );
            transform: rotate(45deg);
            animation: shine 3s infinite;
        }
        @keyframes shine {
            0% { transform: translateY(-100%) rotate(45deg); }
            100% { transform: translateY(100%) rotate(45deg); }
        }
        #coin:active {
            transform: perspective(500px) rotateX(10deg);
        }
        #progressBarContainer {
            width: 100%;
            margin-bottom: 5px;
        }
        #progressBar {
            width: 100%;
            height: 20px;
            background-color: #1f1c30;
            border-radius: 10px;
            overflow: hidden;
        }
        #progress {
            width: 0%;
            height: 100%;
            background-color: #4CAF50;
            transition: width 0.5s;
        }
        #tappingPoints {
            margin-top: 5px;
            font-size: 14px;
        }
        #bottomMenu {
            display: flex;
            justify-content: space-around;
            width: 100%;
            background-color: #1f1c30;
            padding: 10px 0;
        }
        #bottomMenu button {
            background-color: transparent;
            border: none;
            color: red;
            padding: 10px 20px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            margin: 0;
            cursor: pointer;
            transition: background-color 0.3s;
            border-radius: 5px;
        }
        #bottomMenu button.active {
            background-color: #3a3559;
        }
        .points-animation {
            position: absolute;
            font-size: 36px;
            color: #FFD700;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            opacity: 0;
            animation: pointsAnimation 1s ease-out;
        }
        @keyframes pointsAnimation {
            0% { transform: translateY(0); opacity: 1; }
            100% { transform: translateY(-50px); opacity: 0; }
        }
        #boosterPage {
            display: none;
            height: calc(100% - 50px);
            overflow-y: auto;
            padding: 10px;
        }
        .booster-button {
            background-color: #4CAF50;
            border: none;
            color: white;
            padding: 10px 20px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            margin: 5px 2px;
            cursor: pointer;
            border-radius: 5px;
            transition: all 0.3s;
            box-shadow: 0 5px 15px rgba(255,0,0,0.2);
        }
        .booster-button:hover {
            background-color: #45a049;
            transform: translateY(-2px);
            box-shadow: 0 7px 20px rgba(255,0,0,0.3);
        }
        .booster-button:active {
            transform: translateY(1px);
            box-shadow: 0 3px 10px rgba(255,0,0,0.2);
        }
        .booster-button:disabled {
            background-color: #cccccc;
            color: #666666;
            cursor: not-allowed;
        }
        .booster-uses {
            font-size: 14px;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div id="gameContainer">
        <div id="header">
            <div class="framed">
                <h1>VNVNC Coin Battle</h1>
            </div>
            <div id="instructions">Нажимайте на монету, чтобы заработать ⭐️!</div>
            <div class="framed">
                <p id="stars">0 ⭐️</p>
            </div>
        </div>
        <div id="coin"></div>
        <div id="footer">
            <div id="progressBarContainer">
                <div id="progressBar"><div id="progress"></div></div>
                <p id="tappingPoints">2000/2000 ⭐️ available</p>
            </div>
        </div>
    </div>
    <div id="boosterPage">
        <h2>Бустеры</h2>
        <p class="stars-display">0 ⭐️</p>
        <button id="tappingGuru" class="booster-button">Гуру нажатий (2x на 5 мин)</button>
        <p id="tappingGuruUses" class="booster-uses">Осталось: 3</p>
        <button id="fullTank" class="booster-button">Полный бак</button>
        <p id="fullTankUses" class="booster-uses">Осталось: 3</p>
        <button id="multitap" class="booster-button">Мультинажатие (5x на 3 ч) - 500 ⭐️</button>
        <button id="rechargingSpeed" class="booster-button">Скорость зарядки (3x на 3 ч) - 2000 ⭐️</button>
    </div>
    <div id="bottomMenu">
        <button id="tappingPageBtn" class="active">Нажатия</button>
        <button id="boosterPageBtn">Бустеры</button>
    </div>
<script>
    const tgWebApp = window.Telegram.WebApp;
    let userId;
    let stars = 0;
    let tappingPoints = 2000;
    const maxTappingPoints = 2000;
    let tappingMultiplier = 1;
    let rechargeMultiplier = 1;
    let tappingGuruUses = 3;
    let fullTankUses = 3;
    let lastSaveTime = Date.now();
    let saveQueue = [];

    const starsElements = document.querySelectorAll('#stars, .stars-display');
    const tappingPointsElement = document.getElementById('tappingPoints');
    const progressElement = document.getElementById('progress');
    const coinElement = document.getElementById('coin');
    const tappingPageElement = document.getElementById('gameContainer');
    const boosterPageElement = document.getElementById('boosterPage');
    const tappingGuruButton = document.getElementById('tappingGuru');
    const fullTankButton = document.getElementById('fullTank');
    const tappingGuruUsesElement = document.getElementById('tappingGuruUses');
    const fullTankUsesElement = document.getElementById('fullTankUses');

    tgWebApp.ready();

    function authenticateUser() {
        if (tgWebApp.initDataUnsafe && tgWebApp.initDataUnsafe.user) {
            userId = tgWebApp.initDataUnsafe.user.id;
            loadUserData();
        } else {
            console.error('User authentication failed');
            tgWebApp.showAlert('Ошибка аутентификации. Пожалуйста, попробуйте снова позже.');
        }
    }

    function loadUserData() {
        tgWebApp.CloudStorage.getItem(`user_${userId}_data`, (error, result) => {
            if (error) {
                console.error('Error loading user data:', error);
                tgWebApp.showAlert('Ошибка загрузки данных. Пожалуйста, попробуйте снова.');
            } else if (result) {
                const storedData = JSON.parse(result);
                stars = storedData.stars || 0;
                tappingPoints = storedData.tappingPoints || maxTappingPoints;
                tappingGuruUses = storedData.tappingGuruUses || 3;
                fullTankUses = storedData.fullTankUses || 3;
                lastSaveTime = storedData.lastSaveTime || Date.now();
            } else {
                initializeUserData();
            }
            updateUI();
        });
    }

    function saveUserData(data) {
        saveQueue.push(data);
        processSaveQueue();
    }

    function processSaveQueue() {
        if (saveQueue.length === 0) return;

        const dataToSave = saveQueue.shift();
        tgWebApp.CloudStorage.setItem(`user_${userId}_data`, JSON.stringify(dataToSave), (error) => {
            if (error) {
                console.error('Error saving user data:', error);
                saveQueue.unshift(dataToSave); // Put the data back in the queue
                setTimeout(processSaveQueue, 1000); // Try again after 1 second
            } else {
                console.log('User data saved successfully');
                if (saveQueue.length > 0) {
                    processSaveQueue(); // Process next item in queue
                }
            }
        });
    }

    function initializeUserData() {
        stars = 0;
        tappingPoints = maxTappingPoints;
        tappingGuruUses = 3;
        fullTankUses = 3;
        saveUserData({stars, tappingPoints, tappingGuruUses, fullTankUses, lastSaveTime: Date.now()});
    }

    function updateUI() {
        starsElements.forEach(el => el.textContent = `${stars} ⭐️`);
        tappingPointsElement.textContent = `${tappingPoints}/${maxTappingPoints} ⭐️ available`;
        progressElement.style.width = `${(tappingPoints / maxTappingPoints) * 100}%`;
        tappingGuruUsesElement.textContent = `Осталось: ${tappingGuruUses}`;
        fullTankUsesElement.textContent = `Осталось: ${fullTankUses}`;
        updateBoosterButtonStates();
    }

    function updateStars(amount) {
        stars += amount;
        updateUI();
        saveUserData({stars, tappingPoints, tappingGuruUses, fullTankUses, lastSaveTime: Date.now()});
    }

    coinElement.addEventListener('click', (event) => {
        if (tappingPoints > 0) {
            const earnedPoints = tappingMultiplier;
            updateStars(earnedPoints);
            tappingPoints--;
            updateUI();

            tgWebApp.HapticFeedback.impactOccurred('medium');

            const pointsElement = document.createElement('div');
            pointsElement.textContent = `+${earnedPoints} ⭐️`;
            pointsElement.className = 'points-animation';
            pointsElement.style.left = `${event.clientX - coinElement.offsetLeft}px`;
            pointsElement.style.top = `${event.clientY - coinElement.offsetTop}px`;
            coinElement.appendChild(pointsElement);
            setTimeout(() => {
                pointsElement.remove();
            }, 1000);
        } else {
            tgWebApp.HapticFeedback.notificationOccurred('error');
            tgWebApp.showAlert('Нет энергии! Подождите, пока она восстановится, или используйте бустер.');
        }
    });

    setInterval(() => {
        if (tappingPoints < maxTappingPoints) {
            tappingPoints += rechargeMultiplier;
            if (tappingPoints > maxTappingPoints) {
                tappingPoints = maxTappingPoints;
            }
            updateUI();
            saveUserData({stars, tappingPoints, tappingGuruUses, fullTankUses, lastSaveTime: Date.now()});
        }
    }, 1000);

    function updateBoosterButtonStates() {
        tappingGuruButton.disabled = tappingGuruUses === 0;
        fullTankButton.disabled = fullTankUses === 0;
    }

    tappingGuruButton.addEventListener('click', () => {
        if (tappingGuruUses > 0) {
            tappingMultiplier = 2;
            tappingGuruUses--;
            updateUI();
            saveUserData({stars, tappingPoints, tappingGuruUses, fullTankUses, lastSaveTime: Date.now()});
            setTimeout(() => {
                tappingMultiplier = 1;
                updateUI();
                saveUserData({stars, tappingPoints, tappingGuruUses, fullTankUses, lastSaveTime: Date.now()});
            }, 5 * 60 * 1000);
            tgWebApp.HapticFeedback.notificationOccurred('success');
            tgWebApp.showAlert('Гуру нажатий активирован на 5 минут!');
        }
    });

    fullTankButton.addEventListener('click', () => {
        if (fullTankUses > 0) {
            tappingPoints = maxTappingPoints;
            fullTankUses--;
            updateUI();
            saveUserData({stars, tappingPoints, tappingGuruUses, fullTankUses, lastSaveTime: Date.now()});
            tgWebApp.HapticFeedback.notificationOccurred('success');
            tgWebApp.showAlert('Полный бак активирован!');
        }
    });

    document.getElementById('multitap').addEventListener('click', () => {
        if (stars >= 500) {
            stars -= 500;
            tappingMultiplier = 5;
            updateUI();
            saveUserData({stars, tappingPoints, tappingGuruUses, fullTankUses, lastSaveTime: Date.now()});
            setTimeout(() => {
                tappingMultiplier = 1;
                updateUI();
                saveUserData({stars, tappingPoints, tappingGuruUses, fullTankUses, lastSaveTime: Date.now()});
            }, 3 * 60 * 60 * 1000);
            tgWebApp.HapticFeedback.notificationOccurred('success');
            tgWebApp.showAlert('Мультинажатие активировано на 3 часа!');
        } else {
            tgWebApp.HapticFeedback.notificationOccurred('error');
            tgWebApp.showAlert('Недостаточно ⭐️ для активации Мультинажатия!');
        }
    });

    document.getElementById('rechargingSpeed').addEventListener('click', () => {
        if (stars >= 2000) {
            stars -= 2000;
            rechargeMultiplier = 3;
            updateUI();
            saveUserData({stars, tappingPoints, tappingGuruUses, fullTankUses, lastSaveTime: Date.now()});
            setTimeout(() => {
                rechargeMultiplier = 1;
                updateUI();
                saveUserData({stars, tappingPoints, tappingGuruUses, fullTankUses, lastSaveTime: Date.now()});
            }, 3 * 60 * 60 * 1000);
            tgWebApp.HapticFeedback.notificationOccurred('success');
            tgWebApp.showAlert('Скорость зарядки увеличена на 3 часа!');
        } else {
            tgWebApp.HapticFeedback.notificationOccurred('error');
            tgWebApp.showAlert('Недостаточно ⭐️ для увеличения Скорости зарядки!');
        }
    });

    document.getElementById('tappingPageBtn').addEventListener('click', () => {
        tappingPageElement.style.display = 'flex';
        boosterPageElement.style.display = 'none';
        document.getElementById('tappingPageBtn').classList.add('active');
        document.getElementById('boosterPageBtn').classList.remove('active');
    });

    document.getElementById('boosterPageBtn').addEventListener('click', () => {
        tappingPageElement.style.display = 'none';
        boosterPageElement.style.display = 'block';
        document.getElementById('tappingPageBtn').classList.remove('active');
        document.getElementById('boosterPageBtn').classList.add('active');
    });

    authenticateUser();
</script>

</body>
</html>
