<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VNVNC COIN BATTLE</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <!-- The only place external scripts can be imported from is https://cdnjs.cloudflare.com -->
    <style>
        body {
            font-family: 'Roboto', Arial, sans-serif;
            text-align: center;
            margin: 0;
            padding: 0;
            background-color: #000000;
            color: #FFFFFF;
            display: flex;
            flex-direction: column;
            height: 100vh;
            box-sizing: border-box;
            overflow: hidden;
        }
        #gameContainer {
            display: flex;
            flex-direction: column;
            height: calc(100% - 50px);
            justify-content: space-between;
            padding: 10px;
        }
        #header {
            margin-bottom: 10px;
        }
        .framed {
            border: 2px solid var(--tg-theme-button-color, #5682a3);
            border-radius: 10px;
            padding: 5px;
            margin-bottom: 5px;
        }
        h1 {
            font-size: 24px;
            margin: 0;
            font-weight: 700;
            text-shadow: 2px 2px 4px rgba(255, 255, 255, 0.5);
        }
        #instructions {
            font-size: 14px;
            margin-top: 5px;
            background-color: var(--tg-theme-secondary-bg-color, #333333);
            padding: 5px;
            border-radius: 5px;
        }
        #stars {
            font-size: 32px;
            font-weight: bold;
            margin: 0;
        }
        #coin {
            width: 200px;
            height: 200px;
            background: radial-gradient(circle at 30% 30%, #ffd700, #ffb700);
            border-radius: 50%;
            margin: 10px auto;
            cursor: pointer;
            user-select: none;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            color: #2b2640;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
            box-shadow: 
                0 10px 20px rgba(255, 255, 255, 0.4), 
                0 5px 10px rgba(255, 255, 255, 0.3),
                inset 0 -10px 10px -5px rgba(0, 0, 0, 0.5),
                inset 0 10px 10px -5px rgba(255, 255, 255, 0.5);
            position: relative;
            overflow: hidden;
            transition: transform 0.1s;
        }
        #coin::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(
                45deg,
                rgba(255, 255, 255, 0) 0%,
                rgba(255, 255, 255, 0.1) 50%,
                rgba(255, 255, 255, 0) 100%
            );
            transform: rotate(45deg);
            animation: shine 3s infinite;
        }
        @keyframes shine {
            0% { transform: translateY(-100%) rotate(45deg); }
            100% { transform: translateY(100%) rotate(45deg); }
        }
        #coin:active {
            transform: scale(0.95);
        }
        #progressBarContainer {
            width: 100%;
            margin-bottom: 5px;
        }
        #progressBar {
            width: 100%;
            height: 20px;
            background-color: var(--tg-theme-secondary-bg-color, #333333);
            border-radius: 10px;
            overflow: hidden;
        }
        #progress {
            width: 0%;
            height: 100%;
            background-color: var(--tg-theme-button-color, #5682a3);
            transition: width 0.5s;
        }
        #tappingPoints {
            margin-top: 5px;
            font-size: 14px;
        }
        #bottomMenu {
            display: flex;
            justify-content: space-around;
            width: 100%;
            background-color: var(--tg-theme-secondary-bg-color, #333333);
            padding: 10px 0;
        }
        #bottomMenu button {
            background-color: transparent;
            border: none;
            color: var(--tg-theme-text-color, #FFFFFF);
            padding: 10px 20px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            margin: 4px 2px;
            cursor: pointer;
            transition: 0.3s;
            border-radius: 5px;
        }
        #bottomMenu button:hover {
            background-color: var(--tg-theme-button-color, #5682a3);
            color: var(--tg-theme-button-text-color, #FFFFFF);
        }
        .booster-button {
            background-color: var(--tg-theme-button-color, #5682a3);
            color: var(--tg-theme-button-text-color, #FFFFFF);
            border: none;
            padding: 10px 20px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            margin: 4px 2px;
            cursor: pointer;
            transition: 0.3s;
            border-radius: 5px;
        }
        .booster-button:disabled {
            background-color: #cccccc;
            color: #666666;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <div id="gameContainer">
        <div id="header">
            <h1>VNVNC COIN BATTLE</h1>
            <div id="instructions">Нажимай на монету, чтобы заработать звёзды!</div>
        </div>
        <div id="stars" class="framed">0 ⭐</div>
        <div id="coin">VNVNC</div>
        <div id="progressBarContainer">
            <div id="progressBar">
                <div id="progress"></div>
            </div>
            <div id="tappingPoints">0 / 100</div>
        </div>
        <div>
            <button id="tappingGuru" class="booster-button" onclick="useTappingGuru()">Tapping Guru (0)</button>
            <button id="fullTank" class="booster-button" onclick="useFullTank()">Full Tank (0)</button>
        </div>
    </div>
    <div id="bottomMenu">
        <button onclick="showRules()">Правила</button>
        <button onclick="showLeaderboard()">Таблица лидеров</button>
    </div>

    <script>
        let stars = 0;
        let tappingPoints = 0;
        let tappingGuruUses = 0;
        let fullTankUses = 0;
        let lastSaveTime = Date.now();
        const saveInterval = 60000; // Save every minute
        let userData = null;

        function updateUI() {
            document.getElementById('stars').textContent = `${stars} ⭐`;
            document.getElementById('tappingPoints').textContent = `${tappingPoints} / 100`;
            document.getElementById('progress').style.width = `${tappingPoints}%`;
            document.getElementById('tappingGuru').textContent = `Tapping Guru (${tappingGuruUses})`;
            document.getElementById('fullTank').textContent = `Full Tank (${fullTankUses})`;
        }

        function incrementStars() {
            stars++;
            tappingPoints++;
            if (tappingPoints >= 100) {
                stars += 10;
                tappingPoints = 0;
            }
            updateUI();
            saveIfNeeded();
        }

        function useTappingGuru() {
            if (stars >= 100) {
                stars -= 100;
                tappingGuruUses++;
                for (let i = 0; i < 100; i++) {
                    incrementStars();
                }
                updateUI();
                saveUserData();
            }
        }

        function useFullTank() {
            if (stars >= 1000) {
                stars -= 1000;
                fullTankUses++;
                for (let i = 0; i < 1000; i++) {
                    incrementStars();
                }
                updateUI();
                saveUserData();
            }
        }

        function saveIfNeeded() {
            const currentTime = Date.now();
            if (currentTime - lastSaveTime >= saveInterval) {
                saveUserData();
                lastSaveTime = currentTime;
            }
        }

        function saveUserData() {
            const data = {stars, tappingPoints, tappingGuruUses, fullTankUses, lastSaveTime};
            localStorage.setItem('userData', JSON.stringify(data));
            Telegram.WebApp.CloudStorage.setItem('userData', JSON.stringify(data));
        }

        function loadUserData() {
            const localData = localStorage.getItem('userData');
            if (localData) {
                const data = JSON.parse(localData);
                stars = data.stars;
                tappingPoints = data.tappingPoints;
                tappingGuruUses = data.tappingGuruUses;
                fullTankUses = data.fullTankUses;
                lastSaveTime = data.lastSaveTime || Date.now();
                updateUI();
            }
            Telegram.WebApp.CloudStorage.getItem('userData', (error, value) => {
                if (!error && value) {
                    const cloudData = JSON.parse(value);
                    if (cloudData.lastSaveTime > lastSaveTime) {
                        stars = cloudData.stars;
                        tappingPoints = cloudData.tappingPoints;
                        tappingGuruUses = cloudData.tappingGuruUses;
                        fullTankUses = cloudData.fullTankUses;
                        lastSaveTime = cloudData.lastSaveTime;
                        updateUI();
                    }
                }
            });
        }

        function parseInitData() {
            const initData = Telegram.WebApp.initData;
            if (initData) {
                const parsedData = new URLSearchParams(initData);
                userData = JSON.parse(parsedData.get('user') || '{}');
                console.log('User Data:', userData);
            }
        }

        document.getElementById('coin').addEventListener('click', incrementStars);

        function showRules() {
            Telegram.WebApp.showAlert('Правила игры:\n\n1. Нажимайте на монету, чтобы заработать звёзды.\n2. Каждые 100 нажатий дают вам 10 дополнительных звёзд.\n3. Используйте бустеры для быстрого набора очков:\n   - Tapping Guru (100 звёзд): 100 автоматических нажатий\n   - Full Tank (1000 звёзд): 1000 автоматических нажатий\n4. Соревнуйтесь с другими игроками в таблице лидеров!');
        }

        function showLeaderboard() {
            if (userData && userData.first_name) {
                Telegram.WebApp.showAlert(`Таблица лидеров пока недоступна. Следите за обновлениями, ${userData.first_name}!`);
            } else {
                Telegram.WebApp.showAlert('Таблица лидеров пока недоступна. Следите за обновлениями!');
            }
        }

        window.onload = function() {
            loadUserData();
            parseInitData();
        };

        window.onbeforeunload = function() {
            saveUserData();
            return null;
        };

        // Autosave every minute
        setInterval(saveUserData, saveInterval);

        // Initialize Telegram Web App
        Telegram.WebApp.ready();
        Telegram.WebApp.expand();
    </script>
</body>
</html>
